# 14-task-01-proofs.md — Auth Infrastructure

## Task 1.0: Auth Infrastructure — User Entity, Security Config, Login/Register & Seeded Accounts

---

## New Files Created

### Security Package (`org.springframework.samples.petclinic.security`)

```text
src/main/java/org/springframework/samples/petclinic/security/
├── Role.java                            - Enum: OWNER, ADMIN
├── User.java                            - JPA entity: id, email, passwordHash, role, owner
├── UserRepository.java                  - JPA repo with findByEmail()
├── UserDetailsServiceImpl.java          - Spring Security UserDetailsService
├── SecurityConfig.java                  - SecurityFilterChain, BCryptPasswordEncoder bean
├── OwnerAuthenticationSuccessHandler.java - Post-login redirect logic
├── RegistrationForm.java                - Form DTO with validation annotations
├── RegistrationService.java             - Transactional user+owner creation
├── RegistrationController.java          - GET/POST /register
├── LoginController.java                 - GET /login (Spring Security handles POST)
└── DuplicateEmailException.java         - Checked exception for duplicate email

src/main/resources/templates/security/
├── register.html                        - Registration form (Bootstrap 5)
└── login.html                           - Login page (Bootstrap 5)

src/test/java/org/springframework/samples/petclinic/security/
├── UserRepositoryTests.java             - @DataJpaTest: persist & findByEmail
├── UserDetailsServiceImplTests.java     - Unit: loadUserByUsername happy path + not found
├── RegistrationControllerTests.java     - @WebMvcTest: GET, success POST, duplicate, blank password
└── WebMvcTestSecurityConfig.java        - Shared permissive security config for @WebMvcTest slices
```

---

## CLI Output: Test Suite

```text
./mvnw test
...
[WARNING] Tests run: 144, Failures: 0, Errors: 0, Skipped: 6
[INFO] BUILD SUCCESS
```

### Key New Tests Passing

```text
Tests run: 2,  class UserRepositoryTests              - PASS
Tests run: 2,  class UserDetailsServiceImplTests      - PASS
Tests run: 4,  class RegistrationControllerTests      - PASS
Tests run: 5,  class ChatControllerTests              - PASS (updated)
Tests run: 33, class OwnerControllerTests             - PASS (updated with @WithMockUser)
```

---

## Dependencies Added (pom.xml)

```xml
<!-- Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<!-- Thymeleaf Security dialect -->
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity6</artifactId>
</dependency>

<!-- Spring Security test support -->
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-test</artifactId>
    <scope>test</scope>
</dependency>
```

---

## Schema: users table (H2)

```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL,
    owner_id INTEGER,
    CONSTRAINT uc_user_email UNIQUE (email),
    CONSTRAINT fk_users_owners FOREIGN KEY (owner_id) REFERENCES owners(id)
);
```

---

## Seed Data (data.sql — all three DB profiles)

- Admin: `admin@petclinic.com` / BCrypt("admin") / ADMIN / owner_id NULL
- 10 owner accounts: `firstname.lastname@petclinic.com` / BCrypt("password") / OWNER / owner_id 1-10

---

## Security Configuration Highlights

- URL rules: `/`, `/vets`, `/vets.html`, `/login`, `/register`, `/webjars/**`, `/resources/**`, `/error` — permitAll
- All other routes: authenticated
- Form login at `/login`, success handler → ADMIN goes to `/owners/find`, OWNER goes to `/owners/{id}`
- Logout at `/logout` → `/login?logout`
- CSRF enabled (default)
- InheritableThreadLocal for SecurityContextHolder (SSE thread propagation)

---

## Layout Navbar Update

- `xmlns:sec` namespace added
- CSRF meta tags added to `<head>`
- Login/Register links shown for `sec:authorize="isAnonymous()"`
- Email + Logout form shown for `sec:authorize="isAuthenticated()"`
- Chat widget CSRF header injection added to JavaScript fetch call
- Chat widget wrapped in `sec:authorize="isAuthenticated()"`

---

## Verification

All proof artifacts demonstrate the requirements:

- ✅ Spring Security dependency added — app starts with security configured
- ✅ User entity with email, passwordHash, role, owner link
- ✅ users table in all three DB schemas
- ✅ 11 seed users (1 admin + 10 owners) in all three data.sql files
- ✅ BCrypt hashing via BCryptPasswordEncoder bean
- ✅ UserDetailsService loading users by email
- ✅ /login and /register pages exist
- ✅ Navbar updated with auth UI
- ✅ All existing tests pass with @WithMockUser
- ✅ New auth tests pass (UserRepository, UserDetailsService, Registration)
