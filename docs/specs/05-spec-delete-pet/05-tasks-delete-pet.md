# 05-tasks-delete-pet.md

## Relevant Files

### Java — Production

- `src/main/java/org/springframework/samples/petclinic/owner/Owner.java` — Add `orphanRemoval = true` to `@OneToMany` on `pets` and add a `removePet(Pet pet)` method so pets can be individually deleted by removing them from the collection.
- `src/main/java/org/springframework/samples/petclinic/owner/PetController.java` — Add `processDeleteForm()` handler for `POST /owners/{ownerId}/pets/{petId}/delete`.

### Java — Tests

- `src/test/java/org/springframework/samples/petclinic/owner/PetControllerTests.java` — Add failing tests (RED phase) for the delete endpoint: success case, visit-guard case, and non-existent pet.

### Templates and i18n

- `src/main/resources/templates/owners/ownerDetails.html` — Add Delete Pet button (active/disabled), Bootstrap 5 modal markup, and JavaScript to populate the modal with pet name and form action URL.
- `src/main/resources/messages/messages.properties` — Add new delete-related i18n keys (base file).
- `src/main/resources/messages/messages_de.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_es.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_fa.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_ko.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_pt.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_ru.properties` — Add same keys with English placeholder values.
- `src/main/resources/messages/messages_tr.properties` — Add same keys with English placeholder values.

### E2E Tests

- `e2e-tests/tests/pages/pet-page.ts` — Add `clickDeletePetButton(petName)` and `confirmDeletion()` helper methods following the existing Page Object Model pattern.
- `e2e-tests/tests/features/pet-management.spec.ts` — Add the delete pet E2E test: create a pet, open the modal, capture a screenshot, confirm deletion, and assert the pet is gone.

### Proof Artifacts

- `docs/specs/05-spec-delete-pet/05-proofs/05-delete-pet-confirmation-modal.png` — Screenshot of the open Bootstrap modal (auto-generated by the Playwright test and committed as proof). Note: `e2e-tests/test-results/*` is gitignored; screenshots must be saved to this path instead.

### Notes

- Run Java tests with: `./mvnw test -Dtest=PetControllerTests` (unit) and `./mvnw test` (full suite).
- Run E2E tests with: `cd e2e-tests && npm test -- --grep "Delete Pet"` (targeted) or `npm test` (full).
- The `I18nPropertiesSyncTest` will fail if any key present in `messages.properties` is missing from the non-English locale files (except `messages_en.properties` which uses fallback). Add keys to all 7 non-English locale files.
- `messages_en.properties` is excluded from the sync check but should still receive the keys for completeness.
- Flash attributes in `ownerDetails.html` use `${message}` for success (green) and `${error}` for error (red). Use those same keys in `RedirectAttributes.addFlashAttribute(...)`.
- The `@ModelAttribute("pet") findPet()` method in `PetController` already handles the ownership check and throws `ResourceNotFoundException` (→ HTTP 404) if the pet is not found for that owner. The delete handler receives the already-validated `Pet` via this mechanism.
- `Owner.pets` currently uses `CascadeType.ALL` but NOT `orphanRemoval = true`. Without `orphanRemoval = true`, removing a pet from the collection and calling `owners.save(owner)` will NOT delete the pet row in the database. This must be added.

---

## Tasks

### [x] 1.0 Write Failing Controller Tests for Delete Pet Endpoint (RED Phase)

**Purpose:** Follow strict TDD by writing all `PetControllerTests` test cases for the new delete endpoint *before* any production code exists. Tests must fail for the correct reason (no handler mapping).

#### 1.0 Proof Artifact(s)

- Test run: `./mvnw test -Dtest=PetControllerTests` output shows new test methods **failing** (HTTP 404/405 "No mapping" or compilation error) — demonstrates RED phase is complete and tests define the required behavior before implementation.

#### 1.0 Tasks

- [x] 1.1 In `PetControllerTests.java`, add the class constant `private static final int TEST_PET_WITH_VISITS_ID = 3;` alongside the existing `TEST_PET_ID = 1` constant.
- [x] 1.2 In the `@BeforeEach setup()` method, create a third `Pet` with id `TEST_PET_WITH_VISITS_ID` (3), name `"whiskers"`, and one `Visit` (set a date such as `LocalDate.of(2024, 1, 15)` and a description `"Annual checkup"`). Add this visit to the pet via `pet.addVisit(visit)` (or `pet.getVisits().add(visit)`). Add this pet to the owner via `owner.addPet(pet)` — note: since this pet already has an id it is not "new", so you may need to add it directly to `owner.getPets()` rather than via `owner.addPet()` (which skips non-new pets).
- [x] 1.3 Add a new import for `MockMvcResultMatchers.flash` at the top of the test file: `import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.flash;`
- [x] 1.4 Write test method `testProcessDeleteFormSuccess()`: perform a POST to `/owners/{ownerId}/pets/{petId}/delete` using `TEST_OWNER_ID` and `TEST_PET_ID` (the pet with no visits). Assert: `status().is3xxRedirection()`, `view().name("redirect:/owners/{ownerId}")`, and `flash().attributeExists("message")`.
- [x] 1.5 Write test method `testProcessDeleteFormBlockedByVisits()`: perform a POST to `/owners/{ownerId}/pets/{petId}/delete` using `TEST_OWNER_ID` and `TEST_PET_WITH_VISITS_ID` (the pet with a visit). Assert: `status().is3xxRedirection()`, `view().name("redirect:/owners/{ownerId}")`, and `flash().attributeExists("error")`.
- [x] 1.6 Write test method `testProcessDeleteNonExistentPet()`: perform a POST to `/owners/{ownerId}/pets/{petId}/delete` using `TEST_OWNER_ID` and `99999` (a pet ID not in the owner's collection). Assert: `status().isNotFound()` — this is handled automatically by the existing `@ModelAttribute findPet()` mechanism which throws `ResourceNotFoundException` (→ HTTP 404).
- [x] 1.7 Run `./mvnw test -Dtest=PetControllerTests` and confirm the three new tests **fail** (expected: no handler mapping / 404 or 405 response for the delete URL). Keep the output as evidence of the RED phase.

---

### [ ] 2.0 Implement Delete Pet Endpoint in PetController (GREEN + REFACTOR Phase)

**Purpose:** Write the minimum production code to make all failing tests from Task 1.0 pass. Add `POST /owners/{ownerId}/pets/{petId}/delete` with server-side visit guard, JPA deletion via orphanRemoval, and flash message redirect.

#### 2.0 Proof Artifact(s)

- Test run: `./mvnw test -Dtest=PetControllerTests` output shows **all tests passing** — demonstrates GREEN phase is complete.
- Test run: `./mvnw test` exits with `BUILD SUCCESS` — demonstrates no regressions in the full suite.

#### 2.0 Tasks

- [ ] 2.1 In `Owner.java`, update the `@OneToMany` annotation on the `pets` field to add `orphanRemoval = true`:

  ```java
  @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER, orphanRemoval = true)
  ```

- [ ] 2.2 In `Owner.java`, add a `removePet(Pet pet)` public method that removes the given pet from the `pets` list:

  ```java
  public void removePet(Pet pet) {
      this.pets.remove(pet);
  }
  ```

- [ ] 2.3 In `PetController.java`, add the delete handler method. The `owner` and `pet` parameters are automatically populated by the existing `@ModelAttribute` methods (`findOwner()` and `findPet()`), which also handle the ownership check (404 if pet not found for that owner):

  ```java
  @PostMapping("/pets/{petId}/delete")
  public String processDeleteForm(Owner owner, Pet pet, RedirectAttributes redirectAttributes) {
      if (!pet.getVisits().isEmpty()) {
          redirectAttributes.addFlashAttribute("error",
              "Cannot delete " + pet.getName() + ": this pet has visit history.");
          return "redirect:/owners/{ownerId}";
      }
      owner.removePet(pet);
      this.owners.save(owner);
      redirectAttributes.addFlashAttribute("message",
          "Pet " + pet.getName() + " has been successfully deleted.");
      return "redirect:/owners/{ownerId}";
  }
  ```

- [ ] 2.4 Run `./mvnw test -Dtest=PetControllerTests` — all tests (including the three new ones from Task 1.0) must now **pass**. If any test still fails, diagnose and fix before continuing.
- [ ] 2.5 Run the full test suite `./mvnw test` and confirm it exits with `BUILD SUCCESS` with zero test failures.

---

### [ ] 3.0 Update Owner Details UI — Delete Button, Bootstrap Modal, and i18n

**Purpose:** Add the "Delete Pet" button to each pet row on the owner details page. Active (red) for pets with no visits; disabled with tooltip for pets with visits. Add a shared Bootstrap 5 modal confirmation dialog. Add all required i18n message keys to all 9 locale files.

#### 3.0 Proof Artifact(s)

- Test run: `./mvnw test -Dtest=I18nPropertiesSyncTest` passes — demonstrates all locale files have the new keys.
- Test run: `./mvnw test` passes — demonstrates no i18n hardcoded-string violations were introduced in the HTML.
- Manual verification: Navigate to `/owners/1` in a running app and confirm the Delete Pet button renders correctly (red for pets without visits, gray/disabled for pets with visits), and clicking an active button opens the modal.

#### 3.0 Tasks

- [ ] 3.1 Add the following new keys to `src/main/resources/messages/messages.properties`:

  ```properties
  deletePet=Delete Pet
  deletePet.confirm.title=Confirm Delete
  deletePet.confirm.body=Are you sure you want to delete {0}? This action cannot be undone.
  deletePet.confirm.cancel=Cancel
  deletePet.confirm.button=Confirm Delete
  deletePet.blocked.tooltip=Cannot delete: this pet has visit history.
  ```

- [ ] 3.2 Add the same six keys with the same English text as placeholder values to each of these 7 locale files: `messages_de.properties`, `messages_es.properties`, `messages_fa.properties`, `messages_ko.properties`, `messages_pt.properties`, `messages_ru.properties`, `messages_tr.properties`. Also add them to `messages_en.properties` for completeness (it is excluded from the sync check but should stay consistent).
- [ ] 3.3 Run `./mvnw test -Dtest=I18nPropertiesSyncTest` to confirm the sync test passes before touching the HTML.
- [ ] 3.4 In `ownerDetails.html`, locate the inner table row that contains the "Edit Pet" and "Add Visit" action links:

  ```html
  <tr>
    <td><a th:href="@{__${owner.id}__/pets/__${pet.id}__/edit}" th:text="#{editPet}">Edit Pet</a></td>
    <td><a th:href="@{__${owner.id}__/pets/__${pet.id}__/visits/new}" th:text="#{addVisit}">Add Visit</a></td>
  </tr>
  ```

  Add a third `<td>` after the "Add Visit" cell. Inside it, render two mutually exclusive buttons using `th:if` / `th:unless` based on whether `pet.visits` is empty:
  - **Active button** (shown when `${pet.visits.isEmpty()}`): styled `btn btn-danger btn-sm`, with `th:data-pet-name="${pet.name}"`, `th:data-action-url="@{__${owner.id}__/pets/__${pet.id}__/delete}"`, `data-bs-toggle="modal"`, `data-bs-target="#deletePetModal"`, and `th:text="#{deletePet}"`.
  - **Disabled button** (shown when `!${pet.visits.isEmpty()}`): styled `btn btn-secondary btn-sm`, `disabled` attribute, `th:title="#{deletePet.blocked.tooltip}"`, and `th:text="#{deletePet}"`.
- [ ] 3.5 Add the Bootstrap 5 modal markup to `ownerDetails.html` **before the `</body>` closing tag** (after the existing `<script>` block). The modal must use `th:text="#{...}"` on all visible text elements to satisfy the i18n lint check. Include a hidden CSRF input (`th:name="${_csrf.parameterName}"` and `th:value="${_csrf.token}"`) inside the form. The modal's `<div>` element should carry `th:data-confirm-template="#{deletePet.confirm.body}"` so JavaScript can read the localized template string:

  ```html
  <div class="modal fade" id="deletePetModal" tabindex="-1"
       aria-labelledby="deletePetModalLabel" aria-hidden="true"
       th:data-confirm-template="#{deletePet.confirm.body}">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletePetModalLabel" th:text="#{deletePet.confirm.title}">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="deletePetModalBody"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary"
                  data-bs-dismiss="modal" th:text="#{deletePet.confirm.cancel}">Cancel</button>
          <form id="deletePetForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-danger"
                    th:text="#{deletePet.confirm.button}">Confirm Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  ```

- [ ] 3.6 In the existing `<script>` block in `ownerDetails.html`, add a `DOMContentLoaded` listener that intercepts the Bootstrap modal's `show.bs.modal` event. When the event fires, read `data-pet-name` and `data-action-url` from the triggering button, set the modal body text by replacing `{0}` in the i18n template string with the pet name, and set the form `action` attribute to the delete URL:

  ```javascript
  document.addEventListener('DOMContentLoaded', function () {
    var deletePetModal = document.getElementById('deletePetModal');
    if (deletePetModal) {
      deletePetModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var petName = button.getAttribute('data-pet-name');
        var actionUrl = button.getAttribute('data-action-url');
        var template = deletePetModal.getAttribute('data-confirm-template');
        document.getElementById('deletePetModalBody').textContent =
          template.replace('{0}', petName);
        document.getElementById('deletePetForm').setAttribute('action', actionUrl);
      });
    }
  });
  ```

- [ ] 3.7 Run `./mvnw test` to confirm the full suite passes, including `I18nPropertiesSyncTest.checkNonInternationalizedStrings` (no hardcoded HTML text) and `I18nPropertiesSyncTest.checkI18nPropertyFilesAreInSync` (all locale files in sync).

---

### [ ] 4.0 Playwright E2E Test — Full Delete Flow with Confirmation Screenshot

**Purpose:** Implement an automated end-to-end test that exercises the complete delete pet flow: create a pet → open the confirmation modal → capture a screenshot → confirm deletion → assert the pet no longer appears on the owner details page. The screenshot is committed to the spec proofs directory as a permanent artifact.

#### 4.0 Proof Artifact(s)

- Screenshot file: `docs/specs/05-spec-delete-pet/05-proofs/05-delete-pet-confirmation-modal.png` — committed to the repository, clearly shows the Bootstrap modal with the pet name and Confirm Delete button.
- Playwright test run: `cd e2e-tests && npm test -- --grep "Delete Pet"` exits with all matched tests **passing** — demonstrates the full end-to-end flow succeeds in a real browser.

#### 4.0 Tasks

- [ ] 4.1 In `e2e-tests/tests/pages/pet-page.ts`, add two helper methods to the `PetPage` class:
  - `async clickDeletePetButton(petName: string)`: Finds the pet row containing the given pet name, then clicks the active (non-disabled) "Delete Pet" button within that row. Use `page.locator('tr').filter({ has: page.locator('dd', { hasText: petName }) })` to find the correct row.
  - `async confirmDeletion()`: Waits for the Bootstrap modal to be visible (`#deletePetModal.show` or by role `dialog`), then clicks the "Confirm Delete" button inside it.
- [ ] 4.2 Create the proofs output directory so Playwright can write to it. The directory `docs/specs/05-spec-delete-pet/05-proofs/` already exists (created during spec setup), but verify it is present before running the test.
- [ ] 4.3 In `e2e-tests/tests/features/pet-management.spec.ts`, add a new test inside the existing `test.describe('Pet Management', ...)` block:

  ```typescript
  test('can delete a pet with no visit history and verify it is removed', async ({ page }, testInfo) => {
    // 1. Navigate to an owner's details page (use "Betty Davis" from seed data)
    // 2. Add a new pet using createPet() and the existing form-fill pattern
    // 3. Verify the pet appears on the owner details page
    // 4. Click the "Delete Pet" button for the new pet (using PetPage.clickDeletePetButton())
    // 5. Wait for the modal to be visible
    // 6. Capture screenshot to the spec proofs directory:
    //    path: '../docs/specs/05-spec-delete-pet/05-proofs/05-delete-pet-confirmation-modal.png'
    //    (path is relative to the e2e-tests/ directory)
    // 7. Click "Confirm Delete" (using PetPage.confirmDeletion())
    // 8. Wait for redirect back to owner details page
    // 9. Assert the green success message is visible
    // 10. Assert the deleted pet name is NO LONGER visible on the page
  });
  ```

  Follow the existing test style: use `OwnerPage` to navigate, use `createPet()` for test data, use `page.screenshot()` at the modal step, and use `expect()` assertions.
- [ ] 4.4 Run `cd e2e-tests && npm test -- --grep "Delete Pet"` with the Spring Boot app running (`./mvnw spring-boot:run` in a separate terminal). Confirm the test passes and the screenshot file is created at `docs/specs/05-spec-delete-pet/05-proofs/05-delete-pet-confirmation-modal.png`.
- [ ] 4.5 Run the full E2E suite `cd e2e-tests && npm test` to confirm no existing tests are broken by the UI changes (delete button, modal) that were added in Task 3.0.
- [ ] 4.6 Commit the screenshot file `docs/specs/05-spec-delete-pet/05-proofs/05-delete-pet-confirmation-modal.png` to the repository as a permanent proof artifact. Verify with `git status` that the file is tracked (not ignored).
